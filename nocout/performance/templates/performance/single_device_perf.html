{% extends "nocout/base.html" %}

{% block content_title %}
    {{ page_title }} Live <span style="font-size: 25px;">{{ realdevice.device_alias }} ({{ realdevice.ip_address }})</span>
{% endblock %}
{% block content_description %} {% endblock %}
{% load staticfiles %}
{% block css %}
    <!-- JQUERY UI-->
    <link rel="stylesheet" type="text/css"
          href={% static "js/jquery-ui-1.10.3.custom/css/custom-theme/jquery-ui-1.10.3.custom.min.css" %}>
    <script type="text/javascript" src={% static "js/bootstrap-daterangepicker/moment.min.js" %}></script>
    <script type="text/javascript" src={% static "js/bootstrap-daterangepicker/daterangepicker.min.js" %}></script>
{% endblock %}

{% block content %}
    <style>
        .perfContainerBlock .box-title .pull-right .list-inline > li {
            max-width: 200px !important;
        }
        .perfContainerBlock .left_tabs_container {
            padding: 0px !important;
        }
        .inner_tab_container .panel-body {
            padding: 10px !important;
        }
        #tableContainer {
            padding: 0px;
        }
        .top_perf_tabs {
            top:-44px;
            float:left;
            padding-left:15px;
            margin-right:0px;
        }
        .top_perf_tab_content {
            top: -44px;
            position: relative;
        }
    </style>
    <!--Single Device Live Perf Start-->
    <div class='box border lite perfContainerBlock'>
    <div class='box-title'>
        <h4 class="hide">{{ realdevice.device_alias }} ({{ realdevice.ip_address }})</h4>
        <!--Filters Block Start-->
        <div class="">
            <ul class="list-unstyled list-inline" style="margin-bottom:0px;">
                <li class="date_range_filter_container">
                    <div class="input-group">
                        <span class="input-group-addon">
                            <i class="fa fa-calendar"></i>
                        </span>
                        <input type="text" name="reservation" id="reservationtime" class="form-control input-large search-query" value=""/>
                    </div>
                </li>
                <li>
                    <button id="apply_filter" class="btn  btn-default btn-sm">
                        <i class="fa fa-filter"></i> Apply Filter
                    </button>
                </li>
                <li>
                    <button id="reset_filter" class="btn  btn-warning btn-sm">
                        <i class="fa fa-times"></i> Reset Filter
                    </button>
                </li>
                <li>
                    <a href="#" class="btn btn-default btn-sm hide" id="inventory_link_tag" title="Inventory" target="_blank">
                        <i class="fa fa-dropbox text-primary"></i>
                    </a>
                </li>
                <li>
                    <a href="#" class="btn btn-default btn-sm hide" id="alerts_link_tag" title="Alerts" target="_blank">
                        <i class="fa fa-warning text-danger"></i>
                    </a>
                </li>
                <li>
                    <span id="last_polled_val"></span>
                </li>
                <li class="polling_chart_container">
                    <input type="hidden" name="perf_live_poll_input" id="perf_live_poll_input" value="">
                    <div id="perf_live_poll_chart" class=""></div> 
                    <div class="clearfix"></div>
                </li>
            </ul>
        </div>
        <!--Filters Block End-->
        <div class="clearfix"></div>
    </div>
    <div class='box-body'>
        <div class="well well-sm" id="status_container" style="overflow:auto;">
            <div id="latestStatusContainer">
                
            </div>
            <div class="clearfix"></div>
            <table id="status_table" class="table table-responsive table-bordered" style="background:#FFFFFF;margin-bottom:0px !important;">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
    <!--Device Status Block Start-->
    <!-- <button class="btn btn-info btn-xs" title="Hide Status" id="show_status_btn">Hide Status</button>
    <div class="clearfix"></div> -->
    <!--Device Status Block End-->
    <div class="box">
    <div class="box-title" style="background:transparent;"></div>
    <!--Services Tabs & their content Start-->
    {#	        		<div class="tabbable row" id="services_tab_container">#}
    {##}
    {#					</div>#}
    <div id="tableContainer" class="box-body">
    <div class="tabbable header-tabs">
        <ul class="nav nav-tabs top_perf_tabs">
            <li>
                <a href="#utilization_top_tab" id="utilization_top" data-toggle="tab">
                    <span class="hidden-inline-mobile">Utilization</span>
                </a>
            </li>
            <li>
                <a href="#topology_tab" id="topology" class="hide" data-toggle="tab">
                    <span class="hidden-inline-mobile">IA Table</span>
                </a>
            </li>
            <li>
                <a href="#availability_tab" id="availability" data-toggle="tab">
                    <span class="hidden-inline-mobile">Availability</span>
                </a>
            </li>
            <li>
                <a href="#inventory_status_tab" id="inventory_status" data-toggle="tab">
                    <span class="hidden-inline-mobile">Inventory Status</span>
                </a>
            </li>
            <li>
                <a href="#service_status_tab" id="service_status" data-toggle="tab">
                    <span class="hidden-inline-mobile">Service Status</span>
                </a>
            </li>
            <li>
                <a href="#service_perf_tab" id="service_perf" data-toggle="tab">
                    <span class="hidden-inline-mobile">Service Performance</span>
                </a>
            </li>
            <li class="active">
                <a href="#network_perf_tab" id="network_perf" data-toggle="tab">
                    <span class="hidden-inline-mobile">Network Performance</span>
                </a>
            </li>
        </ul>
        <div class="clearfix"></div>
    </div>
    <div>
        <div class="tab-content top_perf_tab_content" style="overflow:auto;">
            <div class="tab-pane active" id="network_perf_tab">
                <div class="panel panel-default inner_tab_container">
                    <div class="panel-body" style="overflow:auto;">
                        <div class="tabbable tabs-left">

                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane" id="service_perf_tab">
                <div class="panel panel-default inner_tab_container">
                    <div class="panel-body" style="overflow:auto;">
                        <div class="tabbable tabs-left">

                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane" id="service_status_tab">
                <div class="panel panel-default inner_tab_container">
                    <div class="panel-body" style="overflow:auto;">
                        <div class="tabbable tabs-left">

                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-pane" id="inventory_status_tab">
                <div class="panel panel-default inner_tab_container">
                    <div class="panel-body" style="overflow:auto;">
                        <div class="tabbable tabs-left">

                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane" id="availability_tab">
                <div class="panel panel-default inner_tab_container">
                    <div class="panel-body" style="overflow:auto;">
                        <div class="tabbable tabs-left">

                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane hide" id="topology_tab">
                <div class="panel panel-default inner_tab_container">
                    <div class="panel-body" style="overflow:auto;">
                        <div class="tabbable tabs-left">

                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane" id="utilization_top_tab">
                <div class="panel panel-default inner_tab_container">
                    <div class="panel-body" style="overflow:auto;">
                        <div class="tabbable tabs-left"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    </div>
    <!--Services Tabs & their content End-->
    </div>
    </div>
    <div class="clearfix"></div>
    </div>
    <!--Single Device Live Perf End-->
    <!-- SPARKLINES -->
    <script type="text/javascript" src={% static "js/sparklines/jquery.sparkline.min.js" %}></script>
    <!--Highcharts Library-->
    <script src={% static "js/highcharts.js" %}></script>
    <script src={% static "js/highcharttheme.js" %}></script>
    <script src={% static "js/highchartstable.js" %}></script>
    <!--Our Custom Script-->
    <script src={% static "js/nocout/nocoutPerfLib.js" %}></script>
    <!--Our Common Utilities Script-->
    <script src={% static "js/nocout/nocoutUtilsLib.js" %}></script>

    <script type="text/javascript">
        /*Global Variables*/
        var perfInstance = "",
            current_device = "",
            device_technology = "",
            live_poll_condition1 = "",
            live_poll_condition2 = "",
            ptp_tech_list = [
                'ptp',
                'p2p',
                'ptp bh'
            ];


        $(document).ready(function (e) {

            var url_array = window.location.href.split("/"),
                page_type_val = "",
                base_url = "";

            /*Set the base url of application for ajax calls*/
            if (window.location.origin) {
                base_url = window.location.origin;
            } else {
                base_url = window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port : '');
            }

            for (var i = 0; i < url_array.length; i++) {
                if (url_array[i].indexOf("_live") > -1) {
                    page_type_val = url_array[i].split("_")[0];
                }
            }

            /*Show SIA tab only for network devices*/
            device_technology = '{{ device_technology }}';

            // Hide Topology tab for PTP
            if(page_type_val == 'customer' || (device_technology.toLowerCase() == 'ptp' || device_technology.toLowerCase() == 'p2p')) {
                if (!$("#topology").hasClass("hide")) {
                    $("#topology").addClass("hide");
                }

                if (!$("#topology_tab").hasClass("hide")) {
                    $("#topology_tab").addClass("hide");
                }

            } else {
                
                if ($("#topology").hasClass("hide")) {
                    $("#topology").removeClass("hide");
                }

                if ($("#topology_tab").hasClass("hide")) {
                    $("#topology_tab").removeClass("hide");
                }
            }


            if(page_type_val == 'other') {
                // Hide Utilization & IA Table Tabs for Backhaul Devices
                if (!$("#utilization_top").hasClass("hide")) {
                    $("#utilization_top").addClass("hide");
                }

                if (!$("#utilization_top_tab").hasClass("hide")) {
                    $("#utilization_top_tab").addClass("hide");
                }

                if (!$("#topology").hasClass("hide")) {
                    $("#topology").addClass("hide");
                }

                if (!$("#topology_tab").hasClass("hide")) {
                    $("#topology_tab").addClass("hide");
                }

            } else {
                // Hide Utilization & RSSI Tabs for all network devices
                if ($("#utilization_top").hasClass("hide")) {
                    $("#utilization_top").removeClass("hide");
                }

                if ($("#utilization_top_tab").hasClass("hide")) {
                    $("#utilization_top_tab").removeClass("hide");
                }

            }

            var current_device_technology = device_technology ? $.trim(device_technology.toLowerCase()) : "";

            // Show/hide live polling button & chart container
            live_poll_condition1 = ptp_tech_list.indexOf(current_device_technology) > -1;
            live_poll_condition2 = page_type_val == 'customer';

            if(!live_poll_condition1 && !live_poll_condition2) {
                $("#perf_poll_now, #perf_live_poll_input, #perf_live_poll_chart").addClass("hide");
            }


            //setting up a custom jquery function to retrive the get paramters.
            $.urlParam = function (name) {
                var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
                if (results == null) {
                    return null;
                }
                else {
                    return results[1] || 0;
                }
            };

            start_date = $.urlParam('start_date');

            if (start_date) {
                $("#start_date").val(decodeURIComponent(start_date));
            }
            end_date = $.urlParam('end_date');
            if (end_date) {
                $("#end_date").val(decodeURIComponent(end_date));
            }
            //set the dropdown to current device value
            $("#device_name").val("{{ device.id }}");

            //on change of selection element in device_name
            // we should redirect user to the new page for the device
            $("#device_name").on('change', function () {
                var new_device = $(this).val();
                var uri = $.url();
                var path = uri.attr('path').split('/');
                path[path.length - 2] = new_device;
                var new_url = uri.attr('protocol') + "://" + uri.attr('host') + ":" + uri.attr('port') + path.join("/");
                window.location.href = new_url;
            });

            Highcharts.setOptions({
                global: {
                    useUTC: false
                }
            });

            /*Initialize Datepicker*/
            $(".datepicker").datepicker({ dateFormat: 'dd-mm-yy' });

            $("#apply_filter").on('click', function () {
                if (startDate && endDate) {
                    //epoch function
                    var myStartDate = startDate.toDate(), myEndDate = endDate.toDate();
                    var myStartTime = myStartDate.getTime() / 1000.0;
                    var myEndTime = myEndDate.getTime() / 1000.0;

                    window.location.href = '{% url "SingleDevicePerf"  page_type device.id %}' + '?start_date=' + encodeURIComponent(myStartTime)
                            + '&end_date=' + encodeURIComponent(myEndTime);

                } else {
                    alert("Select Start & End Date");
                }
                // else {
                //     window.location.href = '{% url "SingleDevicePerf"  page_type device.id %}' + '?start_date=' + encodeURIComponent($("#start_date").val())
                //             + '&end_date=' + encodeURIComponent($("#end_date").val());
                // }
            });

            $("#reset_filter").on('click', function () {
                if (window.location.href.indexOf("?") > -1) {
                    window.location.href = '{% url "SingleDevicePerf"  page_type device.id %}';
                    // window.location.href = window.location.href.split("?")[0];
                }
            });

            $("#download_excel").on('click', function () {

                //get start date and end date from params
                var start_date = $.urlParam('start_date');
                var end_date = $.urlParam('end_date');
                if (!($("#sia").parent().hasClass("active")) && !($("#errors").parent().hasClass("active"))) {
                    var service_name = window.location.href.split('#')[1];
                    var service_data_source = window.location.href.split('#')[2];

                    //if start date and end date is present, url request with epoch start and end date
                    if (start_date && end_date) {
                        window.location.replace('/performance/service/' + service_name + '/service_data_source/' + service_data_source +
                                '/device/{{ device.id }}' +
                                '?download_excel=true' + '&start_date=' + encodeURIComponent(start_date) +
                                '&end_date=' + encodeURIComponent(end_date));
                    } else {
                        window.location.replace('/performance/service/' + service_name + '/service_data_source/' + service_data_source +
                                '/device/{{ device.id }}' +
                                '?download_excel=true' + '&start_date=' + encodeURIComponent($("#start_date").val()) +
                                '&end_date=' + encodeURIComponent($("#end_date").val()));
                    }
                }
            });

            $("#download_csv").on('click', function () {

                //get start date and end date from params
                var start_date = $.urlParam('start_date');
                var end_date = $.urlParam('end_date');

                if (!($("#sia").parent().hasClass("active")) && !($("#errors").parent().hasClass("active"))) {

                    var service_name = window.location.href.split('#')[1];
                    var service_data_source = window.location.href.split('#')[2];

                    //if start date and end date is present, url request with epoch start and end date
                    if (start_date && end_date) {
                        window.location.replace('/performance/service/' + service_name + '/service_data_source/' + service_data_source +
                                '/device/{{ device.id }}' +
                                '?download_csv=true' + '&start_date=' + encodeURIComponent(start_date) +
                                '&end_date=' + encodeURIComponent(end_date))
                    } else {
                        window.location.replace('/performance/service/' + service_name + '/service_data_source/' + service_data_source +
                                '/device/{{ device.id }}' +
                                '?download_csv=true' + '&start_date=' + encodeURIComponent($("#start_date").val()) +
                                '&end_date=' + encodeURIComponent($("#end_date").val()))
                    }
                }
            });


            /*Hide Status Container*/
            //$("#status_container").hide();

            var devicesUrl = base_url + "/" + "{{ get_devices_url }}",
                statusUrl = base_url + "/" + "{{ get_status_url }}" + "/",
                serviceUrl = base_url + "/" + "{{ get_services_url }}" + "/",
                inventory_url = "{{ inventory_page_url }}",
                alert_url = "{{ alert_page_url }}";
            
            inventory_url = inventory_url ? base_url+""+inventory_url : "";
            alert_url = alert_url ? base_url+""+alert_url : "";

            if(inventory_url) {
                $("#inventory_link_tag").attr("href",inventory_url);
                $("#inventory_link_tag").removeClass("hide");
            }

            if(alert_url) {
                $("#alerts_link_tag").attr("href",alert_url);
                $("#alerts_link_tag").removeClass("hide");
            }

            current_device = "{{ device.id }}";
            perfInstance = new nocoutPerfLib();

            /*To Populate the device dropdown*/
            // perfInstance.getAllDevices(devicesUrl, current_device);

            /*To populate the status table*/
            perfInstance.getStatus(statusUrl, current_device);

            /*To populate the services tabs*/
            perfInstance.getServices(serviceUrl, current_device);
        });

        $("#show_status_btn").click(function (e) {

            $("#status_container").slideToggle();
            if ($("#show_status_btn").text() == "Hide Status") {
                $("#show_status_btn").text("Show Status");
            }
            else {
                $("#show_status_btn").text("Hide Status");
            }
        });

        /*Load first inner tab of network performance*/
        $("#network_perf").click(function (e) {
            fetchFirstTabContent(e);
            $.cookie('parent_tab_id', 'network_perf', {path: '/', secure: true});
        });

        /*Load first inner tab of service performance*/
        $("#service_perf").click(function (e) {
            fetchFirstTabContent(e);
            $.cookie('parent_tab_id', 'service_perf', {path: '/', secure: true});
        });

        /*Load first inner tab of service status*/
        $("#service_status").click(function (e) {
            fetchFirstTabContent(e);
            $.cookie('parent_tab_id', 'service_status', {path: '/', secure: true});
        });

        /*Load first inner tab of inventory status*/
        $("#inventory_status").click(function (e) {
            fetchFirstTabContent(e);
            $.cookie('parent_tab_id', 'inventory_status', {path: '/', secure: true});
        });

        /*Load first inner tab of availability*/
        $("#availability").click(function (e) {
            fetchFirstTabContent(e);
            $.cookie('parent_tab_id', 'availability', {path: '/', secure: true});
        });


        /*Load first inner tab of inventory status*/
        $("#topology").click(function (e) {
            fetchFirstTabContent(e);
            $.cookie('parent_tab_id', 'topology', {path: '/', secure: true});
        });

        /*Load first inner tab of Utilization tab*/
        $("#utilization_top").click(function (e) {
            fetchFirstTabContent(e);
            $.cookie('parent_tab_id', 'utilization_top', {path: '/', secure: true});
        });

        /**
         * This function load the first inner tab content when the tab is opened.
         */
        function fetchFirstTabContent(e) {
            var tab_id = e.currentTarget.attributes.href.value.split("#")[1];
            var li_count = $("#" + tab_id + " .inner_tab_container .left_tabs_container ul li").length;
            if (li_count > 0) {
                var activeTabId = $.cookie('activeTabId');
                //if activeTabId is stored in cookie and tabEL exist.
                if (activeTabId && $("#" + tab_id + " .inner_tab_container .left_tabs_container ul li a#" + activeTabId).length) {
                    $("#" + tab_id + " .inner_tab_container .left_tabs_container ul li a#" + activeTabId).trigger('click');
                } else {
                    $("#" + tab_id + " .inner_tab_container .left_tabs_container ul li:first-child a").trigger('click');
                }
            }
        }

        /*This event will collapse & expand device status block*/
        $('.status_box .tools_status .collapse, .status_box .tools_status .expand').click(function () {
            var el = $(this).parents(".status_box").children(".status_body");

            if ($(this).hasClass("collapse")) {
                $(this).removeClass("collapse");
                $(this).addClass("expand");
                $(this).attr("title", "Show Status")
                var i = $(this).children(".fa-chevron-up");
                i.removeClass("fa-chevron-up").addClass("fa-chevron-down");
                el.slideUp();
            } else {
                $(this).removeClass("expand");
                $(this).addClass("collapse");
                $(this).attr("title", "Hide Status");
                var i = $(this).children(".fa-chevron-down");
                i.removeClass("fa-chevron-down").addClass("fa-chevron-up");
                el.slideDown();
            }
        });

        //When poll now button is clicked
        $("body").delegate('#perf_poll_now','click',function(e) {
            var sparkline_dom_id = 'perf_live_poll_chart',
                hidden_input_dom_id = 'perf_live_poll_input',
                polled_val_shown_dom_id = "last_polled_val",
                device_name = "{{ device.device_name }}",
                current_active_tab_url = $(".top_perf_tab_content div.active .left_tabs_container ul li.active a").attr("url"),
                service_name = "",
                ds_name = "",
                container_id = "",
                block_dom_id_str = $(".top_perf_tab_content div.active .left_tabs_container ul li.active a").attr("href");

            if(current_active_tab_url && current_active_tab_url.indexOf("service/") > -1 && current_active_tab_url.indexOf("service_data_source/") > -1 ) {
                service_name = current_active_tab_url ? current_active_tab_url.split("service/")[1].split("/")[0] : "";
                ds_name = current_active_tab_url ? current_active_tab_url.split("service_data_source/")[1].split("/")[0] : "";
            }

            if(block_dom_id_str && block_dom_id_str.indexOf("#") > -1) {
                container_id = "last_updated_"+container_id.split("#")[1];
            }
            
            if(live_poll_condition1 || live_poll_condition2) {
                if(device_name && service_name && ds_name) {
                    // Disable the "Poll Now" button
                    $("#perf_poll_now").button("loading");

                    // Call function to fetch live polling data
                    perfInstance.livePollCurrentDevice(
                        container_id,
                        sparkline_dom_id,
                        hidden_input_dom_id,
                        polled_val_shown_dom_id,
                        service_name,
                        ds_name,
                        [device_name]
                    );
                }
            }

        });

    </script>

{% endblock %}


{% block load_js %}
    <script>
        var startDate, endDate;
        jQuery(document).ready(function () {
            App.setPage("");  //Set current page
            App.init(); //Initialise plugins and elements


            var oldStartDate = $.urlParam('start_date') ? new Date($.urlParam('start_date') * 1000) : new Date();
            var oldENdData = $.urlParam('end_date') ? new Date($.urlParam('end_date') * 1000) : new Date();

            $('#reservationtime').daterangepicker(
                    {
                        timePicker: true,
                        timePickerIncrement: 1,
                        // format: 'd/m/Y H:M:S' ,
                        opens: "right",
                        showDropdowns: true,
                        ranges: {
                            'Today': [moment().startOf('day'), moment()],
                            'Last 24 Hours': [moment().subtract('days', 1), moment()],
                            'Last 7 Days': [moment().subtract('days', 6), moment()],
                            'Last 30 Days': [moment().subtract('days', 29), moment()],
                            'This Month': [moment().startOf('month'), moment().endOf('month')],
                            'Last Month': [moment().subtract('month', 1).startOf('month'), moment().subtract('month', 1).endOf('month')]
                        },
                        buttonClasses: ['btn btn-default'],
                        applyClass: 'btn-small btn-primary',
                        cancelClass: 'btn-small',
                        format: "DD-MM-YYYY HH:mm:ss",
                        separator: ' to ',
                        startDate: oldStartDate,
                        endDate: oldENdData
                    },
                    function (start, end) {
                        startDate = start;
                        endDate = end;
                    }
            );

            if ($.urlParam('start_date') && $.urlParam('end_date')) {
                $('#reservationtime').val(moment(oldStartDate).format("DD-MM-YYYY HH:mm:ss") + '  to  ' + moment(oldENdData).format("DD-MM-YYYY HH:mm:ss"));
                startDate = moment(oldStartDate);
                endDate = moment(oldENdData);
            }

            // setTimeout(function() {
            //     if($.cookie('activeTabId')) {
            //         $('#'+$.cookie('activeTabId')).trigger('click');
            //     }
            // }, 100);
        });

        // Add click event to technology on breadcrumb
        $("body").delegate(".perf_tech_breadcrumb",'click',function(e) {
            // Go back to last tab
            window.history.go(tabs_click_counter);
        });
    </script>
{% endblock %}
