{% extends "nocout/base.html" %}

{% load django_bootstrap_breadcrumbs %}
{% block breadcrumb_title %}
    {% clear_breadcrumbs %}
    <!-- Create Breadcrumbs -->
    {% breadcrumb_safe "<i class='fa fa-file-text'></i> Performance Reports" "javascript:;" %}
    {% breadcrumb_safe page_type|title|add:" Live" "performance_listing" page_type %}

    {% if page_type == 'network' and device_technology|upper == 'P2P'  %}
        {% breadcrumb_safe "PTP BH" "performance_listing" page_type  %}
    {% else %}
        {% if page_type == 'customer' and device_technology|upper == 'P2P'  %}
            {% breadcrumb_safe "PTP" "performance_listing" page_type  %}
        {% else %}
            {% breadcrumb_safe device_technology|upper "performance_listing" page_type  %}
        {% endif %}
    {% endif %}
    {% breadcrumb_safe bs_alias|add:" ("|add:realdevice.ip_address|add:")" "javascript:;" %}
    <!-- Render the created breadcrumbs -->
    {% render_breadcrumbs "django_bootstrap_breadcrumbs/bootstrap3.html" %}
{% endblock %}

{% load staticfiles %}
{% block css %}
    <!-- JQUERY UI-->
    <link rel="stylesheet" type="text/css" href={% static "js/jquery-ui-1.10.3.custom/css/custom-theme/jquery-ui-1.10.3.custom.min.css" %}>

    <link rel="stylesheet" type="text/css" href={% static "js/bootstrap-switch/bootstrap-switch.min.css" %}>
    <script type="text/javascript" src={% static "js/bootstrap-daterangepicker/moment.min.js" %}></script>
    <script type="text/javascript" src={% static "js/bootstrap-daterangepicker/daterangepicker.min.js" %}></script>
{% endblock %}

{% block content %}
    <style>
        .perfContainerBlock .box-title .pull-right .list-inline > li {
            max-width: 200px !important;
        }
        .perfContainerBlock .left_tabs_container {
            /*padding: 0px !important;*/
        }
        .inner_tab_container .panel-body {
            padding: 10px !important;
        }
        #tableContainer {
            padding-left: 0px;
        }
        .top_perf_tabs {
            top: 0px !important;
            float: left;
            padding-left: 15px;
            margin-right: 0px !important;
        }
        .box .header-tabs .top_perf_tabs > li > a {
            padding: 7px 5px !important;
        }
        .top_perf_tab_content, .top_perf_tab_content .panel .panel-body {
            overflow: auto;
        }
        .chart_container h3, .last_updated_container h3, #latestStatusContainer h3 {
            margin-top: 0px;
        }
    </style>
    <!--Device Status Block Start-->
    <div class="well well-sm" id="status_container" style="overflow:auto;">
        <div id="latestStatusContainer">
            <h3><i class="fa fa-spinner fa-spin" title="Fetching Current Status"></i></h3>
        </div>
        <div style="overflow:auto;">
            <table id="status_table" class="table table-bordered" style="background:#FFFFFF;margin-bottom:0px !important;">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <!--Device Status Block End-->
    <!--Single Device Live Perf Start-->
    <div class='box border lite perfContainerBlock'>
        <div class='box-title'>
            <h4 class="hide">{{ realdevice.device_alias }} ({{ realdevice.ip_address }})</h4>
            <!-- Filters Block - Start-->
            <ul class="list-unstyled list-inline" style="margin-bottom:0px;">
                <li class="date_range_filter_container">
                    <div class="input-group">
                        <span class="input-group-addon">
                            <i class="fa fa-calendar"></i>
                        </span>
                        <input type="text" name="reservation" id="reservationtime" class="form-control input-large search-query" value="" readonly/>
                    </div>
                </li>
                <li>
                    <button id="apply_filter" class="btn  btn-default btn-sm">
                        <i class="fa fa-filter"></i>
                    </button>
                </li>
                <li class="reset_filter_li">
                    <button id="reset_filter" class="btn  btn-danger btn-sm">
                        <i class="fa fa-times"></i>
                    </button>
                </li>
                {% if settings.ENABLE_UNIFIED_SERVICE_VIEW %}
                <li id="display_type_container" class="unified_item_type">
                {% else %}
                <li id="display_type_container">
                {% endif %}
                    <label class="checkbox-inline hide">
                        <input type="radio" id="display_chart" name="item_type" value="chart" checked="checked"/>  Display Chart
                    </label>
                    <label class="checkbox-inline hide">
                        <input type="radio" id="display_table" name="item_type" value="table"/>  Display Table
                    </label>

                    <div class="btn-group dropdown">
                        <button class="btn  btn-default dropdown-toggle" data-toggle="dropdown" id="item_type_btn" title="Display Chart/Table">
                            <i class="text-primary fa fa-bar-chart-o"> </i>  Display Chart
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu context" id="item_type_ul">
                            <li class="active">
                                <a href="javascript:;" radioId="display_chart">
                                    <i class="fa fa-bar-chart-o"> </i> Display Chart
                                </a>
                            </li>
                            <li>
                                <a href="javascript:;" radioId="display_table">
                                    <i class="fa fa-table"> </i> Display Table
                                </a>
                            </li>
                        </ul>
                    </div>

                </li>
                {% if settings.ENABLE_UNIFIED_SERVICE_VIEW %}
                <li class="unified_normal_li">
                    <label class="checkbox-inline hide">
                        <input type="radio" id="normal_view" name="service_view_type" value="normal" checked="checked"/> Datasource View
                    </label>
                    <label class="checkbox-inline hide">
                        <input type="radio" id="unified_view" name="service_view_type" value="unified"/>  Service View
                    </label>

                    <div class="btn-group dropdown">
                        <button class="btn  btn-default dropdown-toggle" data-toggle="dropdown" id="service_view_type_btn" title="Datasource/Service View">
                            <i class="text-primary fa fa-bar-chart-o"> </i> Datasource View
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu context" id="service_view_type_ul">
                            <li class="active">
                                <a href="javascript:;" radioId="normal_view">
                                    <i class="fa fa-bar-chart-o"> </i> Datasource View
                                </a>
                            </li>
                            <li>
                                <a href="javascript:;" radioId="unified_view">
                                    <i class="fa fa-bar-chart-o"> </i> Service View
                                </a>
                            </li>
                        </ul>
                    </div>
                </li>
                {% endif %}

                {% if settings.ENABLE_AGGREGATE_REPORT_DOWNLOAD %}
                <li class="unified_normal_li">
                    <div class="btn-group dropdown">
                        <button class="btn  btn-default dropdown-toggle" data-toggle="dropdown" id="service_view_type_btn" title="Download Reports">
                            <i class="text-primary fa fa-download"> </i> Report
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu context" id="service_view_type_ul">
                            <li class="active">
                                <a href="javascript:;">
                                    <i class="fa fa-download"> </i> Single Service(Live + Historical)
                                </a>
                            </li>
                            <li>
                                <a href="javascript:;">
                                    <i class="fa fa-download"> </i> All Services(5 min data)
                                </a>
                            </li>
                        </ul>
                    </div>
                </li>
                {% endif %}

                <li class="pull-right">
                    <a href="#" class="btn btn-default btn-sm hide" id="inventory_link_tag" title="Inventory" target="_blank">
                        <i class="fa fa-dropbox text-primary"></i>
                    </a>
                </li>
                <li class="pull-right">
                    <a href="#" class="btn btn-default btn-sm hide" id="alerts_link_tag" title="Alerts" target="_blank">
                        <i class="fa fa-warning text-danger"></i>
                    </a>
                </li>
            </ul>
            <!--Filters Block End-->
            <div class="clearfix"></div>
        </div>
        <div class='box-body'>
            <!-- <div id="tableContainer" class="box-body"> -->
            <div class="tabbable header-tabs">
                <ul class="nav nav-tabs top_perf_tabs">
                    <li>
                        <a href="#utilization_top_tab" title="Utilization" id="utilization_top" data-toggle="tab">
                            <i class="fa fa-angle-double-right">&nbsp;</i>
                            <span class="hidden-inline-mobile">Utilization</span>
                        </a>
                    </li>
                    <li>
                        <a href="#topology_tab" id="topology" title="IA Table" class="hide" data-toggle="tab">
                            <i class="fa fa-angle-double-right">&nbsp;</i>
                            <span class="hidden-inline-mobile">IA Table</span>
                        </a>
                    </li>
                    <li>
                        <a href="#availability_tab" id="availability" title="Availability" data-toggle="tab">
                            <i class="fa fa-angle-double-right">&nbsp;</i>
                            <span class="hidden-inline-mobile">Availability</span>
                        </a>
                    </li>
                    <li>
                        <a href="#inventory_status_tab" id="inventory_status" title="Inventory Status" data-toggle="tab">
                            <i class="fa fa-angle-double-right">&nbsp;</i>
                            <span class="hidden-inline-mobile">Inventory Status</span>
                        </a>
                    </li>
                    <li>
                        <a href="#service_status_tab" id="service_status" title="Service Status" data-toggle="tab">
                            <i class="fa fa-angle-double-right">&nbsp;</i>
                            <span class="hidden-inline-mobile">Service Status</span>
                        </a>
                    </li>
                    <li>
                        <a href="#service_perf_tab" id="service_perf" title="Service Performance" data-toggle="tab">
                            <i class="fa fa-angle-double-right">&nbsp;</i>
                            <span class="hidden-inline-mobile">Service Performance</span>
                        </a>
                    </li>
                    <li class="active">
                        <a href="#network_perf_tab" id="network_perf" title="Network Performance" data-toggle="tab">
                            <i class="fa fa-angle-double-right">&nbsp;</i>
                            <span class="hidden-inline-mobile">Network Performance</span>
                        </a>
                    </li>
                </ul>
                <div class="clearfix"></div>
            </div>
            <div class="tab-content top_perf_tab_content">
                <div class="tab-pane active" id="network_perf_tab">
                    <div class="panel panel-default inner_tab_container">
                        <div class="panel-body">
                            <div class="tabbable tabs-left">
                                <i class="fa fa-spinner fa-spin" title="Fetching Network Performance Services"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="service_perf_tab">
                    <div class="panel panel-default inner_tab_container">
                        <div class="panel-body">
                            <div class="tabbable tabs-left">
                                <i class="fa fa-spinner fa-spin" title="Fetching Service Performance Services"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="service_status_tab">
                    <div class="panel panel-default inner_tab_container">
                        <div class="panel-body">
                            <div class="tabbable tabs-left">
                                <i class="fa fa-spinner fa-spin" title="Fetching Service Status Services"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane" id="inventory_status_tab">
                    <div class="panel panel-default inner_tab_container">
                        <div class="panel-body">
                            <div class="tabbable tabs-left">
                                <i class="fa fa-spinner fa-spin" title="Fetching Inventory Status Services"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane" id="availability_tab">
                    <div class="panel panel-default inner_tab_container">
                        <div class="panel-body">
                            <div class="tabbable tabs-left">
                                <i class="fa fa-spinner fa-spin" title="Fetching Availability Services"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane hide" id="topology_tab">
                    <div class="panel panel-default inner_tab_container">
                        <div class="panel-body">
                            <div class="tabbable tabs-left">
                                <i class="fa fa-spinner fa-spin" title="Fetching IA Table Services"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane" id="utilization_top_tab">
                    <div class="panel panel-default inner_tab_container">
                        <div class="panel-body">
                            <div class="tabbable tabs-left">
                                <i class="fa fa-spinner fa-spin" title="Fetching Utilization Services"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="clearfix"></div>
            </div>
        </div>
        <!-- </div> -->
        <div class="clearfix"></div>
    </div>
    <!--Single Device Live Perf End-->
    <!-- SPARKLINES -->
    <script type="text/javascript" src={% static "js/sparklines/jquery.sparkline.min.js" %}></script>
    <!--Highcharts Library-->
    <script src={% static "js/highcharts.js" %}></script>
    <script src={% static "js/highcharttheme.js" %}></script>
    <script src={% static "js/highchartstable.js" %}></script>
    <script src={% static "js/exporting.js" %}></script>
    <!--Our Custom Script-->
    <script src={% static "js/nocout/nocoutPerfLib.js" %}></script>
    <!--Our Common Utilities Script-->
    <script src={% static "js/nocout/nocoutUtilsLib.js" %}></script>
    <!-- Custom script for data table-->
    <script type="text/javascript" src={% static "js/utils/jqueryDataTable.js" %}></script>
    <!-- Bootstrap switch lib for BS maintenance infowindow -->
    <script type="text/javascript" src={% static "js/bootstrap-switch/bootstrap-switch.min.js" %} ></script>
    <script type="text/javascript">
        /*Global Variables*/
        var perfInstance = "",
            dateRangePicker_domId = "reservationtime",
            current_device = "",
            device_technology = "",
            live_poll_condition1 = "",
            live_poll_condition2 = "",
            ptp_tech_list = ['ptp','p2p','ptp bh'],
            is_perf_polling_enabled = false,
            show_historical_on_performance = false,
            is_unified_enabled = false,
            base_url = "",
            startDate = "",
            endDate = "",
            dataTableInstance = "",
            current_device_ip = "",
            device_name = "",
            bold_class = "",
            is_dr_device = false
            warn_color = "",
            crit_color = "",
            warn_type = "",
            crit_type = "",
            default_live_table_headers = [];


        $(document).ready(function (e) {

            service_view_type = $('input[name="service_view_type"]:checked').val();
            device_status_url = "{{ get_status_url }}" ? $.trim("{{ get_status_url }}") : "";
            get_services_url = "{{ get_services_url }}" ? $.trim("{{ get_services_url }}") : "";
            inventory_page_url = "{{ inventory_page_url }}" ? $.trim("{{ inventory_page_url }}") : "";
            alert_page_url = "{{ alert_page_url }}" ? $.trim("{{ alert_page_url }}") : "";
            page_type_val = "{{ page_type }}" ? $.trim("{{ page_type }}") : "customer";
            is_util_tab = "{{ is_util_tab }}" ? Number($.trim("{{ is_util_tab }}")) : 0;
            current_device_technology = "";
            statusUrl = "";
            serviceUrl = "";
            inventory_url = "";
            alert_url = "";

            {% if not settings.ENABLE_UNIFIED_SERVICE_VIEW %}
                $.cookie("service_view_type", 'normal', {path: '/'});
            {% endif %}

            initPerformancePage(true);
        });

        function initPerformancePage(is_first_triggered) {

            if ($.cookie("service_view_type") == 'normal') {
                default_live_table_headers = default_live_table_headers_without_ds;
            } else {
                default_live_table_headers = default_live_table_headers_with_ds;
            }

            if (is_first_triggered) {
                
                if ($.cookie("service_view_type")) {
                    $('input[value="' + $.cookie("service_view_type") + '"]').prop('checked', true)
                    $('input[value="' + $.cookie("service_view_type") + '"]').attr('checked', 'checked');

                    updateServiceTypeDropdownHtml();
                }

                statusUrl = getCompleteUrl(device_status_url);
                serviceUrl = getCompleteUrl(get_services_url);
                inventory_url = getCompleteUrl(inventory_page_url);
                alert_url = getCompleteUrl(alert_page_url);

                current_device = "{{ device.id }}";
                device_technology = '{{ device_technology }}' ? '{{ device_technology }}' : "";
                current_device_technology = device_technology ? $.trim(device_technology.toLowerCase()) : "";
                current_device_ip = '{{ realdevice.ip_address }}' ? '{{ realdevice.ip_address }}' : "";
                is_perf_polling_enabled = $.parseJSON('{{ live_poll_config|safe }}');
                is_perf_polling_enabled = is_perf_polling_enabled ? is_perf_polling_enabled['performance'] : false;
                device_name = current_device;
                warn_color = "{{ settings.WARN_COLOR}}";
                warn_type = "{{ settings.WARN_TYPE}}";
                crit_color = "{{ settings.CRIT_COLOR}}";
                crit_type = "{{ settings.CRIT_TYPE}}";
                // Update global variable as per context data
                {% if is_dr_device %}
                    is_dr_device = true;
                    bold_class = 'text-bold';
                {% endif %}

                /*Make a instance of ourDataTableWidget class */
                dataTableInstance = new ourDataTableWidget();

                {% if settings.HISTORICAL_ON_PERFORMANCE %}
                    show_historical_on_performance = true;
                {% endif %}
                
                // If call for utilization tab the reset tab cookie
                if(is_util_tab) {
                    $.cookie('parent_tab_id', '', {path: '/', secure: true});
                }


                // Show/hide live polling button & chart container
                live_poll_condition1 = ptp_tech_list.indexOf(current_device_technology) > -1;
                live_poll_condition2 = page_type_val == 'customer';
                if(!live_poll_condition1 && !live_poll_condition2) {
                    $(".perf_poll_now, #perf_live_poll_input, #perf_live_poll_chart").addClass("hide");
                }

                if(inventory_url) {
                    $("#inventory_link_tag").attr("href",inventory_url);
                    $("#inventory_link_tag").removeClass("hide");
                }

                if(alert_url) {
                    $("#alerts_link_tag").attr("href",alert_url);
                    $("#alerts_link_tag").removeClass("hide");
                }

                // SET utc false for highcharts to show time in GMT+5:30
                Highcharts.setOptions({
                    global: {
                        useUTC: false
                    }
                });

                // Create nocoutPerfLib instance to access its functions
                perfInstance = new nocoutPerfLib();

                perfInstance.togglePerfPageElements(page_type_val, current_device_technology);

                /*To initialize date range picker*/
                perfInstance.initDateRangePicker(dateRangePicker_domId);
            }

            // Add 'service_view_type' GET param to API url
            if (serviceUrl.indexOf('service_view_type') == -1) {
                serviceUrl = serviceUrl.indexOf('?') > -1 ? serviceUrl + '&service_view_type='+$.cookie("service_view_type") : serviceUrl + '?service_view_type='+$.cookie("service_view_type");
            } else {
                serviceUrl = serviceUrl.split('&service_view_type=')[0];
                serviceUrl = serviceUrl.indexOf('?') > -1 ? serviceUrl + '&service_view_type='+$.cookie("service_view_type") : serviceUrl + '?service_view_type='+$.cookie("service_view_type");
            }

            /*To populate the status table*/
            perfInstance.getStatus(statusUrl, current_device);

            /*To populate the services tabs*/
            perfInstance.getServices(serviceUrl, current_device);
        }
    
        /**
         * This event triggers when apply filter button clicked
         * @event click
         */
        $("#apply_filter").on('click', function () {
            if(startDate && endDate) {
                var active_tab_obj = nocout_getPerfTabDomId(),
                    service_id = active_tab_obj["active_dom_id"] ? active_tab_obj["active_dom_id"] : "",
                    get_service_data_url = active_tab_obj["active_tab_api_url"] ? active_tab_obj["active_tab_api_url"] : "";

                if(
                    service_id.indexOf('availability') > -1
                    ||
                    service_id.indexOf('utilization_top') > -1
                    ||
                    service_id.indexOf('topology') > -1
                ) {

                    var active_inner_tab = $('.top_perf_tab_content div.active .inner_tab_container .nav-tabs li.active a'),
                        service_id = active_inner_tab.attr("id").slice(0, -4),
                        get_service_data_url = active_inner_tab.attr("url");

                } 

                if(get_service_data_url && service_id && current_device) {
                    perfInstance.initGetServiceData(get_service_data_url, service_id, current_device);
                }
            } else {
                alert("Select Start & End Date");
            }
        });

        /**
         * This event triggers when reset filter button clicked
         * @event click
         */
        $("#reset_filter").on('click', function () {
            if(startDate && endDate) {

                startDate = "";
                endDate = "";
                
                // Remove daterangepicker from DOM
                $('#'+dateRangePicker_domId).daterangepicker().remove();
                
                // Add daterangepicker to DOM
                $(".date_range_filter_container .input-group").append(date_range_picker_html);
                
                /*To initialize date range picker*/
                perfInstance.initDateRangePicker(dateRangePicker_domId);

                var active_tab_obj = nocout_getPerfTabDomId(),
                    service_id = active_tab_obj["active_dom_id"] ? active_tab_obj["active_dom_id"] : "",
                    get_service_data_url = active_tab_obj["active_tab_api_url"] ? active_tab_obj["active_tab_api_url"] : "";

                if(
                    service_id.indexOf('availability') > -1
                    ||
                    service_id.indexOf('utilization_top') > -1
                    ||
                    service_id.indexOf('topology') > -1
                ) {

                    var active_inner_tab = $('.top_perf_tab_content div.active .inner_tab_container .nav-tabs li.active a'),
                        service_id = active_inner_tab.attr("id").slice(0, -4),
                        get_service_data_url = active_inner_tab.attr("url");

                } 

                if(get_service_data_url && service_id && current_device) {
                    // perfInstance.getServiceData(get_service_data_url, service_id, current_device);
                    perfInstance.initGetServiceData(get_service_data_url, service_id, current_device);
                }
            }
        });

        /**
         * This event triggers when any parent tab is clicked and 
           it loads first inner tab when any parent tab is clicked
         * @event click
         */
        $("#network_perf,\
           #service_perf,\
           #service_status,\
           #inventory_status,\
           #availability,\
           #topology,\
           #utilization_top"
        ).click(function (e) {
            fetchFirstTabContent(this);
        });

        /**
         * This function load the first inner tab content when any parent tab is clicked.
         * @method fetchFirstTabContent
         * @param this_pointer {Object}, It contains the clicked tab 'this' pointer object
         */
        function fetchFirstTabContent(this_pointer) {

            var tab_id = $(this_pointer).attr("href") ? $(this_pointer).attr("href").split("#")[1] : "",
                li_count = $("#"+tab_id+" .inner_tab_container ul.left_tabs_container li").length;

            // Save parent tab reference in cookie
            $.cookie('parent_tab_id', tab_id.slice(0, -4), {path: '/', secure: true});

            if (li_count > 0) {

                if($("#other_perf_table").length > 0) {
                    $("#other_perf_table").dataTable().fnDestroy();
                    $("#other_perf_table").remove();
                }

                if($("#perf_data_table").length > 0) {
                    $("#perf_data_table").dataTable().fnDestroy();
                    $("#perf_data_table").remove();
                }

                var activeTabId = $.cookie('activeTabId');
                //if activeTabId is stored in cookie and tabEL exist.
                if (activeTabId && $("#"+tab_id+" .inner_tab_container ul.left_tabs_container li a#" + activeTabId).length) {
                    $("#"+tab_id+" .inner_tab_container ul.left_tabs_container li a#" + activeTabId).trigger('click');
                } else {
                    $("#"+tab_id+" .inner_tab_container ul.left_tabs_container li:first-child a").trigger('click');
                }
            }
        }


        /**
         * This function load the first inner inner tab content when any inner tab is clicked.
         * @event click
         */
        $("body").delegate('.left_tabs_container li','click',function(e) {
            var tab_content_id = e.target.id ? e.target.id.slice(0, -4) : "";
            if(tab_content_id && $("#"+tab_content_id+"_block .tabbable").length > 0) {

                if($("#other_perf_table").length > 0) {
                    $("#other_perf_table").dataTable().fnDestroy();
                    $("#other_perf_table").remove();
                }

                if($("#perf_data_table").length > 0) {
                    $("#perf_data_table").dataTable().fnDestroy();
                    $("#perf_data_table").remove();
                }

                $(".inner_tab_container #"+tab_content_id+"_block .inner_inner_tab li:first-child a").trigger('click');
            }
        });

        /**
         * This event triggers when poll now button clicked
         * @event click
         */
        // $(".perfContainerBlock").delegate('.perf_poll_now, .poll_play_btn','click',function(e) {
        //     initSingleDevicePolling(function(response) {
        //         // pass
        //     });
        // });
    </script>

{% endblock %}


{% block load_js %}
    <script type="text/javascript">
        jQuery(document).ready(function () {
            App.setPage("");  //Set current page
            App.init(); //Initialise plugins and elements
        });
    </script>
{% endblock %}
