{% extends "nocout/base.html" %}
{% block breadcrumb_title %}
    <a href="/home">Home</a> >
    <li><a href="#">Alert Center</a></li>
    <li><a href="#">{{ page_type }}</a></li>
    <li><a href="/device/">device</a></li>
    <li><a href="/device/{{ current_device_id }}">{{ current_device_id }}</a></li>
    <li><b>{{ service_name }}</b></li>
{% endblock %}
{% block content_title %}
    {{ page_type | title }} Alert <span style="font-size: 25px;">{{ device_alias }}</span>
{% endblock %}
{% block content_description %} {% endblock %}
{% load staticfiles %}
{% block css %}
    <!-- JQUERY UI-->
    <link rel="stylesheet" type="text/css" href={% static "js/jquery-ui-1.10.3.custom/css/custom-theme/jquery-ui-1.10.3.custom.min.css" %}>
    
{% endblock %}

{% load sds %}

{% block content %}
    <style>
        .perfContainerBlock .box-title .pull-right .list-inline > li {
            max-width: 200px !important;
        }
    </style>
    <!--Single Device Live Perf Start-->
    <div class='box border lite perfContainerBlock'>
    <div class='box-title'>
        <h4 class="hide"><i class='fa fa-file-text'></i>{{ device_alias }}</h4>

        <ul class="list-unstyled list-inline" style="margin-bottom:0px;">
            <li class="date_range_filter_container">
                <div class="input-group">
                    <span class="input-group-addon">
                        <i class="fa fa-calendar"></i>
                    </span>
                    <input type="text" name="reservation" id="reservationtime" class="form-control input-large search-query" value=""/>
                </div>
            </li>
            <li>
                <button id="apply_filter" class="btn  btn-default btn-sm">
                    <i class="fa fa-filter"></i> Apply Filter
                </button>
            </li>
            <li>
                <button id="reset_filter" class="btn  btn-warning btn-sm">
                    <i class="fa fa-times"></i> Reset Filter
                </button>
            </li>
            <li>
                <a href="#" class="btn btn-default btn-sm hide" id="inventory_link_tag" title="Inventory" target="_blank">
                    <i class="fa fa-dropbox text-primary"></i>
                </a>
            </li>
            <li>
                <a href="#" class="btn btn-default btn-sm hide" id="perf_link_tag" title="Performance" target="_blank">
                    <i class="fa fa-bar-chart-o text-primary"></i>
                </a>
            </li>
        </ul>
        <div class="clearfix"></div>
    </div>
    <div class='box-body'>

        <div class="well well-sm" id="status_container" style="overflow:auto;">
            <div id="latestStatusContainer">
                
            </div>
            <table id="status_table" class="table table-responsive table-bordered" style="background:#FFFFFF;margin-bottom:0px !important;">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="box">
            <div class="box-title" style="background:transparent;"></div>
            <div id="single_device_alert_container" class="box-body">
                <div class="tabbable header-tabs">
                    <ul id="" class="nav nav-tabs" style="top:-44px;float:left;padding-left:15px;margin-right:0px;">
                        <li>
                            <a href="#network_alert_service_block" id="network_alert_service_tab" data-toggle="tab">
                                <span class="hidden-inline-mobile">Polling Alerts</span>
                            </a>
                        </li>
                        <li>
                            <a href="#network_alert_down_block" id="network_alert_down_tab" data-toggle="tab">
                                <span class="hidden-inline-mobile">Down</span>
                            </a>
                        </li>
                        <li>
                            <a href="#network_alert_packet_block" id="network_alert_packet_tab" data-toggle="tab">
                                <span class="hidden-inline-mobile">Packet Drop</span>
                            </a>
                        </li>
                        <li>
                            <a href="#network_alert_latency_block" id="network_alert_latency_tab" data-toggle="tab">
                                <span class="hidden-inline-mobile">Latency</span>
                            </a>
                        </li>
                        <li class="active">
                            <a href="#network_alert_ping_block" id="network_alert_ping_tab" data-toggle="tab">
                                <span class="hidden-inline-mobile">Ping Details</span>
                            </a>
                        </li>
                    </ul>
                    <div class="clearfix"></div>
                    <div class="tab-content" style="overflow-y:auto;">
                        <div class="tab-pane" id="network_alert_service_block">
                            <table id="network_alert_service_table" class="datatable table table-striped table-bordered table-hover">
                                <thead></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="tab-pane" id="network_alert_down_block">
                            <table id="network_alert_down_table" class="datatable table table-striped table-bordered table-hover">
                                <thead></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="tab-pane" id="network_alert_packet_block">
                            <table id="network_alert_packet_table" class="datatable table table-striped table-bordered table-hover">
                                <thead></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="tab-pane" id="network_alert_latency_block">
                            <table id="network_alert_latency_table" class="datatable table table-striped table-bordered table-hover">
                                <thead></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="tab-pane active" id="network_alert_ping_block">
                            <table id="network_alert_ping_table" class="datatable table table-striped table-bordered table-hover">
                                <thead></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="clearfix"></div>
        </div>
        <!-- <div style="overflow:auto;">
            <table id="device_alert" cellpadding="0" cellspacing="0" border="0" class="datatable table table-striped table-bordered table-hover hide">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div> -->
    </div>
    </div>

    <!-- Custom script for data table-->
    <script type="text/javascript" src={% static "js/utils/jqueryDataTable.js" %}></script>
    <script type="text/javascript" src={% static "js/bootstrap-daterangepicker/moment.min.js" %}></script>
    <script type="text/javascript" src={% static "js/bootstrap-daterangepicker/daterangepicker.min.js" %}></script>
    <script src={% static "js/nocout/nocoutPerfLib.js" %}></script>
    <!--Our Common Utilities Script-->
    <script src={% static "js/nocout/nocoutUtilsLib.js" %}></script>
    <!-- Library to load tab content on tab click-->
    <script type="text/javascript" src={% static "js/nocout/openTabContentLib.js" %}></script>

    <script type="text/javascript">

        var startDate = "",
            endDate = "",
            base_url = "",
            perfInstance = "",
            current_device_id = "",
            service_name = "",
            excel_columns = [],
            isDateFilterApplied = false;

        $(document).ready(function (e) {

            var current_device = "{{ current_device_name }}",
                statusUrl = base_url + "/" + "{{ get_status_url }}" + "/",
                service_status_url = "",
                page_type = "{{ page_type }}",
                inventory_url = "{{ inventory_page_url }}",
                perf_page_url = "{{ perf_page_url }}",
                device_technology = "{{ device_technology_name }}",
                gridHeadersObj = '{{ table_headers|safe }}',
                ping_gridHeadersObj = '{{ ping_table_headers|safe }}',
                oldStartDate = $.urlParam('start_date') ? new Date($.urlParam('start_date') * 1000) : new Date(),
                oldENdData = $.urlParam('end_date') ? new Date($.urlParam('end_date') * 1000) : new Date(),
                location_array = window.location.href.split("#");

            if(location_array.length > 1) {
                window.location.href = location_array[0];
            }

            current_device_id = "{{ current_device_id }}";

            /*Make a instance of ourDataTableWidget class */
            dataTableInstance = new ourDataTableWidget();

            //Create instance of nocoutPerfLib
            perfInstance = new nocoutPerfLib();

            /*To populate the status table*/
            perfInstance.getStatus(statusUrl, current_device);

            // Initialize daterange picker
            $('#reservationtime').daterangepicker({
                timePicker: true,
                timePickerIncrement: 1,
                // format: 'd/m/Y H:M:S' ,
                opens: "right",
                showDropdowns: true,
                ranges: {
                    'Today': [moment(), moment()],
                    'Last 24 Hours': [moment().subtract(1, 'days'), moment()],
                    'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                    'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                    'This Month': [moment().startOf('month'), moment().endOf('month')],
                    'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                },
                buttonClasses: ['btn btn-default'],
                applyClass: 'btn-small btn-primary',
                cancelClass: 'btn-small',
                format: "DD-MM-YYYY HH:mm:ss",
                separator: ' to ',
                startDate: oldStartDate,
                endDate: oldENdData
            },function (start, end) {
                $('#reservationtime span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
                startDate = start;
                endDate = end;
            });
    
            // Calculate start & end date if available in query string
            if ($.urlParam('start_date') && $.urlParam('end_date')) {
                $('#reservationtime').val(moment(oldStartDate).format("DD-MM-YYYY HH:mm:ss") + '  to  ' + moment(oldENdData).format("DD-MM-YYYY HH:mm:ss"));
                startDate = moment(oldStartDate);
                endDate = moment(oldENdData);
            }

            // Ajax url to get grid data
            var ajax_url = '{% url "SingleDeviceAlertsListing_clone" page_type current_device_id %}';

            $("#network_alert_service_tab").attr("data_url", ajax_url);
            $("#network_alert_service_tab").attr("data_header", gridHeadersObj);

            $("#network_alert_down_tab").attr("data_url", ajax_url);
            $("#network_alert_down_tab").attr("data_header", gridHeadersObj);

            $("#network_alert_packet_tab").attr("data_url", ajax_url);
            $("#network_alert_packet_tab").attr("data_header", gridHeadersObj);

            $("#network_alert_latency_tab").attr("data_url", ajax_url);
            $("#network_alert_latency_tab").attr("data_header", gridHeadersObj);

            $("#network_alert_ping_tab").attr("data_url", ajax_url);
            $("#network_alert_ping_tab").attr("data_header", ping_gridHeadersObj);

            if ((location_array.length > 1 && location_array[1] == "") || (location_array.length == 1)) {
                /*Trigger click event on active tab to load its data*/
                $("#network_alert_ping_tab").trigger('click', true);
            }
        });

        // When any filter is applied
        $("#apply_filter").on('click', function () {
            if(startDate && endDate) {

                isDateFilterApplied = true;
                //epoch function
                var myStartDate = startDate.toDate(), myEndDate = endDate.toDate();
                var myStartTime = myStartDate.getTime() / 1000.0;
                var myEndTime = myEndDate.getTime() / 1000.0;
                // window.location.href = window.location.href+'?start_date=' + encodeURIComponent(myStartTime)
                //         + '&end_date=' + encodeURIComponent(myEndTime);
                // window.location.search = '?start_date=' + encodeURIComponent(myStartTime)+ '&end_date=' + encodeURIComponent(myEndTime);
                var active_tab = $("#single_device_alert_container li.active").children("a"),
                    active_tab_id = active_tab.length > 0 ? active_tab[0].id : "";

                if(active_tab_id) {
                    $("#"+active_tab_id).trigger("click",true);
                }

            } else {
                alert("Select Start & End Date");
            }
        });

        // When filter reset
        $("#reset_filter").on('click', function () {
            // if (window.location.href.indexOf("?") > -1) {
            //     window.location.href = window.location.href.split("?")[0];
            // }
            isDateFilterApplied = false;

            $('#reservationtime').val("")
            var active_tab = $("#single_device_alert_container li.active").children("a"),
                active_tab_id = active_tab.length > 0 ? active_tab[0].id : "";

            if(active_tab_id) {
                $("#"+active_tab_id).trigger("click",true);
            }
        });

        function findStringFromUrl() {
            var uri = $.url();
            var path = uri.attr('path').split('/');
            return path[path.length - 2 ]
        }

        function replaceString(mainString, toReplace, replaceWith) {
            var str = mainString, res;
            if (toReplace === "service") {
                res = str.replace(toReplace + "/", replaceWith + "/");
            } else {
                res = str.replace(toReplace, replaceWith);
            }

            return res;
        }

        function selectTab(tabId) {
            $(tabId).parent().addClass('active').siblings().removeClass('active');
        }

        $("#reset_filter").on('click', function () {
            if (window.location.href.indexOf("?") > -1) {
                window.location.href = window.location.href.split("?")[0];
            }
        });

        /**
         * This  function get the device service(PL) status i.e. Status & AGE
         * @method getPlServiceStatus
         * @param url {String}, It contains the API url to fetch the service status.
         */
        function getPlServiceStatus(url) {
            if(url) {
                $.ajax({
                    url: base_url + "" + url,
                    type: "GET",
                    success: function (response) {
                        var result = "";

                        if (typeof response == 'string') {
                            result = JSON.parse(response);
                        } else {
                            result = response;
                        }

                        if (result.data && result.data.objects) {
                            
                            // Call function to populate latest status info
                            populateDeviceStatus_nocout("latestStatusContainer",result.data.objects);
                        }
                    },
                    error: function (err) {
                        // console.log(err.statusText);
                    }
                });
            }
        }
    </script>

{% endblock %}

{% block load_js %}
    <script>
        App.init(); //Initialise plugins and elements
    </script>
{% endblock %}